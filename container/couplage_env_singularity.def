Bootstrap: localimage
From: miniconda3_py37_4.11.0.sif
# on part d'un conteneur pré-construit avec miniconda3 et python 3.7

%environment
    export LC_ALL=C
    export LC_NUMERIC=en_GB.UTF-8

%runscript
    # Execute script python
    python "$@"

%post
	apt update
	apt upgrade -y
	DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC apt install -y tzdata

	apt install -y build-essential wget bzip2 unzip git gfortran freeglut3-dev libxext-dev libxrender-dev libglib2.0-0 libqhull-dev
	

	# installation des dépendances creation env conda
	conda install mamba -c conda-forge
	conda clean -y --all
    apt autoremove --purge
    apt clean
	mamba install -v openalea.mtg openalea.lpy openalea.deploy openalea.sconsx xlrd coverage nose sphinx pytest statsmodels numpy scipy=1.7.3 pandas sphinx_rtd_theme scons -c conda-forge -c openalea3 -y

	# CARIBU
	git clone -b namespace https://github.com/pradal/caribu
	cd caribu
	python setup.py install
    # copie des exécutables dans le bin de conda
    find build-scons/bin/ ! '(' -name '*.exe' ')' -type f -exec cp "{}" /opt/miniconda/bin/ \;
	cd ..
    

	# adel
	git clone -b namespace https://github.com/pradal/adel
	cd adel
	python setup.py develop
	cd ..

	# astk
	git clone -b namespace https://github.com/pradal/astk
	cd astk
	python setup.py install
	cd ..

    # Wheat-Fspm
    git clone https://github.com/openalea-incubator/WheatFspm.git
    cd WheatFspm
	# modifie les dépôts pour avoir derniere version sur rbarillot
	sed -i -e 's/openalea-incubator\/fspm-wheat/rbarillot\/fspm-wheat/' .gitmodules
	sed -i -e 's/openalea-incubator\/cn-wheat/rbarillot\/cn-wheat/' .gitmodules
	sed -i -e 's/openalea-incubator\/elong-wheat/rbarillot\/elong-wheat/' .gitmodules
    # télécharge les modules 
    git submodule update --init --recursive
    git submodule update --remote
    # change de branche
    cd fspm-wheat && git checkout mobidiv && cd ..
    cd cn-wheat && git checkout mobidiv && cd ..
    cd elong-wheat && git checkout emergence && cd ..
	# installation
    python setup.py develop
    cd ..

	# l-egume
	git clone -b Develop https://github.com/glouarn/l-egume.git
    cd l-egume
	python setup.py develop
    cd ..

	# PyRATP
	git clone -b update_mobidiv https://github.com/mwoussen/PyRATP.git
	cd PyRATP
	make
	make clean
	cd ..

	# lightvegemanager
	git clone https://github.com/mwoussen/lightvegemanager.git
	cd lightvegemanager
	python setup.py develop
	cd ..

	# 3ds Soil
	git clone https://github.com/glouarn/soil3ds.git
	cd soil3ds
	sed -i -e 's/import\ IOtable/from\ soil3ds\ import\ IOtable/' soil3ds/soil_moduleW.py
	python setup.py develop
	cd ..
