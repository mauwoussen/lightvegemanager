Bootstrap: docker
From: ubuntu:20.04
#ubuntu:20.04 debian:9.5-slim

%files

%environment
    export LC_ALL=C
    export LC_NUMERIC=en_GB.UTF-8
    export PATH="/opt/miniconda/bin:$PATH"

%runscript
    # Execute container
    python /lightvegemanager/runscripts/cnwheat/cnwheat_Vegetative_stages_lvm.py "$@"

%post
    #essential stuff but minimal
    apt update

    #for security fixe:
    apt upgrade -y
    DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC apt install -y tzdata
    apt install -y build-essential wget bzip2 git python3.9 unzip gfortran freeglut3-dev libxext-dev libxrender-dev libglib2.0-0 libqhull-dev

    # miniconda3, dernière version, python 3.9, v4.11.0
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
        
    #install conda
    bash  miniconda.sh -b -p /opt/miniconda 
    export PATH="/opt/miniconda/bin:$PATH"

    #cleanup    
    conda clean -y --all
    rm -f /opt/miniconda.sh
    apt autoremove --purge
    apt clean

    # installation des dépendances (préférable)
    conda install python=3.7 openalea.mtg openalea.plantgl openalea.lpy alinea.caribu alinea.astk xlrd coverage nose sphinx statsmodels numpy scipy pandas progressbar2 -c conda-forge -c fredboudon

    # installe adel (requis par WheatFspm)
    wget https://github.com/rbarillot/adel/archive/python3.zip
    unzip python3.zip && cd adel-python3
    python setup.py develop
    cd -
    rm python3.zip

    # clone du depot 
    git clone -b singularity https://github.com/mwoussen/lightvegemanager.git
    cd lightvegemanager

    # installe Wheat-Fspm
    git clone --recurse-submodules https://github.com/openalea-incubator/WheatFspm.git
    cd WheatFspm
    git submodule update --remote
    python setup.py develop

    # compile la partie fortran de PyRATP (pour linux 64bits)
    cd ../PyRATP/f90
    bash compile_pyratp_lin64.sh

    # finalement installe lightvegemanager
    cd ../..
    python setup.py develop